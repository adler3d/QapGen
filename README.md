# QapGen

> Подробный обзор: [QapDSL: декларативный AST и парсеры для C++ (Хабр)](https://habr.com/ru/articles/916006/)

QapGen — автогенератор C++-структур, AST и парсеров по декларативной схеме (QapDSL).

...

# Сравнение: QapDSL, tree-sitter, syn, TreeDL, Clang LibTooling

## 1. Общая цель и область применения

| Система          | Основное назначение                                           | Тип задачи                |
|------------------|--------------------------------------------------------------|---------------------------|
| QapDSL           | Парсинг, AST, компактные DSL, автогенерация кода             | Трансляторы, DSL, анализ  |
| tree-sitter      | Быстрый парсер для редакторов, инкрементальный синтакс-анализ | IDE, редакторы, подсветка |
| syn (Rust)       | Парсинг Rust-кода в procedural macros                        | Макросы, code-gen для Rust|
| TreeDL           | Декларативное описание AST, генерация кода для AST           | Компиляторы, анализаторы  |
| Clang LibTooling | Инструменты работы с C/C++ AST, разбор, рефакторинг          | Анализ, рефакторинг, IDE  |

---

## 2. Подход к описанию грамматики и структуры

| Система          | Описание грамматики         | Описание AST                 | Интеграция действий          |
|------------------|----------------------------|------------------------------|------------------------------|
| QapDSL           | Да (гибко, в стиле C++ кода)| Да (через классы/структуры)  | Нет                          |
| tree-sitter      | Да (JS/C объект-правила)    | Автоматически из грамматики  | Нет                          |
| syn (Rust)       | Нет (ручной разбор syn::*)  | Да (Rust-структуры/Enums)    | Да, вне синтаксиса           |
| TreeDL           | Нет (только структура AST)  | Да (очень формально)         | Нет                          |
| Clang LibTooling | Нет (готовая грамматика)    | Да (готовые C++ AST классы)  | Да, через C++ API            |

---

## 3. Инкрементальность, скорость, интеграция

| Система          | Инкрементальный разбор | Скорость        | Встраивание в IDE/редакторы | Языки поддержки         |
|------------------|-----------------------|-----------------|-----------------------------|-------------------------|
| QapDSL           | Нет                   | Высокая         | Можно встроить, но вручную  | Любые при описании      |
| tree-sitter      | Да                    | Очень высокая   | IDE, редакторы (VSCode, NeoVim)| Многоязычный (через грамм.)|
| syn (Rust)       | Нет                   | Средняя/высокая | Только Rust (build/macros)  | Только Rust             |
| TreeDL           | Нет                   | Высокая         | Нет (ген-код для AST)       | Любые (C++, Java, Py...)|
| Clang LibTooling | Нет                   | Средняя         | Отлично для IDE/рефакторов  | Только C/C++            |

---

## 4. Работа с AST и действиями

| Система          | Явное AST | Сопутствующие действия | Генерация кода/преобразования | API для пользовательской логики |
|------------------|-----------|------------------------|-------------------------------|----------------------------------|
| QapDSL           | Да        | Нет                    | Нет                           | Нет (только через расширение C++-кода, вне QapDSL) |
| tree-sitter      | Нет       | Нет                    | Нет                           | Да (через tree-sitter API)       |
| syn (Rust)       | Да        | Да (в procedural macros)| Да (build macros/derive)       | Да (Rust-API)                    |
| TreeDL           | Да        | Нет                    | Да (генерация AST-кода)        | Нет (только структура)           |
| Clang LibTooling | Да        | Да (C++ AST visitors)  | Да (через трансформации)       | Да (C++-API)                     |

---

## 5. Крутость для разных задач

| Система          | Парсер для редактора | Генерация кода | Компилятор | Анализатор | Рефакторинг | Быстрый старт |
|------------------|---------------------|----------------|------------|------------|-------------|--------------|
| QapDSL           | +-                  | -              | ++         | +          | +-          | ++           |
| tree-sitter      | +++                 | -              | -          | +          | -           | +++          |
| syn (Rust)       | -                   | ++             | -          | +          | -           | +            |
| TreeDL           | -                   | +++            | ++         | ++         | -           | +            |
| Clang LibTooling | +                   | +              | +          | +++        | +++         | -            |

**Легенда:**  
+++ — идеально подходит  
++ — хорошо подходит  
+ — можно использовать  
+- — ограниченно  
- — не предназначен

---

## QapDSL: "API для пользовательской логики"

QapDSL **не предоставляет явного API для пользовательской логики** внутри самого DSL.  
Вся логика реализуется только на стороне C++ в виде методов/классов вне QapDSL-файла.  
Внутри QapDSL допустимы только вызовы go*-методов, которые возвращают флажок (bool), и после каждого вызова обязательно идёт проверка этого флажка для выхода из функции при ошибке.  
Пример:

```cpp
bool go(i_dev& dev) {
  t_fallback scope(dev,__FUNCTION__);
  auto& ok = scope.ok;
  auto& M = scope.mandatory;
  M += dev.go_str<t_type>(type_name);
  if (!ok) return ok;
  // ... остальные шаги
  return ok;
}
```

Внутри DSL — только декларация структуры и последовательность go*-вызовов (без условий, циклов, пользовательского кода).

---
